<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI To-Do List Agent (Professional)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen text-slate-100">
  <div class="w-full max-w-md bg-slate-800 p-8 rounded-xl shadow-2xl shadow-slate-950/70">
    
    <div id="addTaskScreen" class="space-y-5">
      <h1 class="text-2xl font-extrabold text-center text-indigo-400 tracking-wide">AI Project Manager</h1>
      
      <textarea id="taskInput" rows="3" placeholder="e.g. Finish urgent homework tomorrow 5pm" 
        class="w-full p-4 rounded-lg bg-slate-700/70 text-slate-100 border border-slate-600 
               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
        oninput="handleInput(this.value)"></textarea>
      
      <div id="suggestionsBox" class="hidden bg-slate-700 p-2 rounded-lg text-sm space-y-2 border border-indigo-600/50"></div>

      <button onclick="addTask()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-full font-bold shadow-md 
               shadow-indigo-500/30 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed">
        Add Task
      </button>
      <button onclick="showList()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-full font-bold shadow-md transition duration-150">
        View Tasks
      </button>
    </div>
    
    <div id="taskListScreen" class="hidden space-y-5">
      <h1 class="text-2xl font-extrabold text-center text-indigo-400 tracking-wide">Your Tasks</h1>
      <ul id="taskList" class="space-y-4"></ul>

      <h2 class="text-lg font-extrabold pt-2 border-t border-slate-700">‚úÖ Completed</h2>
      <ul id="completedList" class="space-y-4"></ul>

      <button onclick="backToAdd()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-full font-bold mt-6 shadow-md transition duration-150">
        Add More
      </button>
    </div>
    
  </div>

  <script>
    let tasks = [];
    let completed = [];

    // ===========================================
    // EXTERNAL API ENDPOINTS
    // ===========================================
    // NOTE: Uses absolute URLs to correctly target the Node.js server (Port 3000)
    const API_ANALYZE_ENDPOINT = '/api/analyze'; 
    const API_SUGGEST_ENDPOINT = '/api/suggest'; 

    // ===========================================
    // AI SUGGESTION LOGIC
    // ===========================================
    
    let suggestionTimeout;
    function handleInput(text) {
        clearTimeout(suggestionTimeout);
        let trimmedText = text.trim();
        
        if (trimmedText.length < 3) {
            document.getElementById("suggestionsBox").classList.add("hidden");
            return;
        }
        
        suggestionTimeout = setTimeout(() => {
            fetchAISuggestions(trimmedText);
        }, 500);
    }

    async function fetchAISuggestions(text) {
        let box = document.getElementById("suggestionsBox");
        box.innerHTML = '<div class="text-center text-indigo-400 animate-pulse">Loading AI suggestions...</div>';
        box.classList.remove("hidden");

        try {
            const response = await fetch(API_SUGGEST_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ partial_task: text })
            });

            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }

            const data = await response.json();
            const suggestions = data.suggestions || []; 

            box.innerHTML = ""; 
            
            if (suggestions.length > 0) {
                suggestions.forEach(s => {
                    let btn = document.createElement("button");
                    btn.className = "block w-full text-left bg-slate-700 hover:bg-indigo-600/50 p-2 rounded-md transition duration-150";
                    btn.textContent = s;
                    btn.onclick = () => {
                        document.getElementById("taskInput").value = s;
                        box.classList.add("hidden");
                    };
                    box.appendChild(btn);
                });
                box.classList.remove("hidden");
            } else {
                 box.innerHTML = '<div class="text-center text-slate-400">No AI suggestions found.</div>';
                 box.classList.remove("hidden");
            }

        } catch (error) {
            console.error("Error fetching AI suggestions:", error);
            box.innerHTML = '<div class="text-center text-red-400">Suggestion service unavailable.</div>';
        }
    }


    // ===========================================
    // AI TASK ANALYSIS LOGIC (Calls backend for analysis)
    // ===========================================

    async function addTask() {
      let input = document.getElementById("taskInput").value.trim();
      if (!input) return alert("Please enter a task!");

      // 1. Show loading state on button
      const addButton = document.querySelector('button[onclick="addTask()"]');
      const originalButtonText = addButton.textContent;
      addButton.textContent = 'Analyzing Task...'; 
      addButton.disabled = true;

      try {
          // 2. Call the AI Analysis Endpoint
          const response = await fetch(API_ANALYZE_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ task_text: input })
          });

          if (!response.ok) {
              throw new Error("AI analysis service failed to respond.");
          }

          // 3. Get and validate structured task object
          let analyzed = await response.json();
          
          analyzed.status = analyzed.status || "Pending";
          
          tasks.push(analyzed);

          document.getElementById("taskInput").value = "";
          document.getElementById("suggestionsBox").classList.add("hidden");
          
          alert("AI analyzed and added task: " + analyzed.text);
          
      } catch (error) {
          console.error("Error adding task via AI:", error);
          alert("Could not analyze task. Please check the backend connection.");
      } finally {
          // 4. Restore button state
          addButton.textContent = originalButtonText;
          addButton.disabled = false;
      }
    }
    
    // ===========================================
    // TASK MANAGEMENT LOGIC (Includes Overdue Check & Professional Layout)
    // ===========================================

    function showList() {
        let list = document.getElementById("taskList");
        let completedList = document.getElementById("completedList");
        list.innerHTML = "";
        completedList.innerHTML = "";

        // Helper function to get today's date as a comparable string (YYYY-MM-DD)
        const getTodayString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const today = getTodayString();
        
        // Sorts tasks by urgency (urgent=true comes first)
        tasks.sort((a, b) => b.urgent - a.urgent);

        // Pending Tasks
        tasks.forEach((task, index) => {
            let li = document.createElement("li");
            
            // --- OVERDUE LOGIC ---
            let statusTag = 'üìå Pending'; // Default status tag
            let timeClass = '';
            let isOverdue = false;

            // Check if a specific YYYY-MM-DD date exists in the time field
            if (task.time && task.time.match(/^\d{4}-\d{2}-\d{2}$/)) {
                if (task.time < today) {
                    statusTag = 'üî¥ OVERDUE';
                    timeClass = 'text-red-400 font-extrabold'; 
                    isOverdue = true;
                }
            }
            
            // Determine primary status tag
            if (task.urgent) {
                statusTag = 'üö® URGENT';
            } else if (isOverdue) {
                 statusTag = 'üî¥ OVERDUE';
            } else if (task.time.includes(today)) {
                 statusTag = 'üóìÔ∏è TODAY'; // If date includes today's YYYY-MM-DD
            }
            
            // Determine list item border color based on urgency or overdueness
            let urgencyBorder = task.urgent || isOverdue ? 'border-l-4 border-red-500' : 'border-l-4 border-slate-500';

            // Apply professional styling
            li.className = `p-4 rounded-md bg-slate-700/50 flex flex-col ${urgencyBorder}`;
            
            li.innerHTML = `
              <div class="flex justify-between items-center mb-1">
                <span class="${task.urgent || isOverdue ? 'text-red-400 font-extrabold tracking-tight' : 'font-semibold'}">
                  ${task.text}
                </span>
                <button onclick="completeTask(${index})" class="text-emerald-400 hover:text-emerald-500 font-bold ml-4 p-1 rounded transition duration-150">‚úî Done</button>
              </div>
              
              <p class="text-xs text-slate-400 pt-1 flex items-center justify-between">
                <span>
                    <span class="${timeClass}">üìÖ ${task.time}</span> 
                    | üè∑ ${task.category}
                </span>
                <span class="font-bold px-2 py-0.5 rounded-full text-slate-100 bg-indigo-700/70 text-[10px]">
                    ${statusTag}
                </span>
              </p>
              
              <p class="text-xs text-slate-400 mt-2 italic">${task.note}</p>
            `;
            list.appendChild(li);
        });

        // Completed Tasks
        completed.forEach(task => {
            let li = document.createElement("li");
            li.className = "p-4 rounded-md bg-slate-700/30 flex flex-col opacity-70 border-l-4 border-emerald-500";
            
            li.innerHTML = `
              <div class="flex justify-between items-center line-through">
                <span>${task.text}</span>
                <span class="text-emerald-300 font-bold">‚úî Completed</span>
              </div>
              <p class="text-xs text-slate-400 mt-1">üìÖ ${task.time} | üè∑ ${task.category}</p>
            `;
            completedList.appendChild(li);
        });

        document.getElementById("addTaskScreen").classList.add("hidden");
        document.getElementById("taskListScreen").classList.remove("hidden");
    }

    function backToAdd() {
      document.getElementById("taskListScreen").classList.add("hidden");
      document.getElementById("addTaskScreen").classList.remove("hidden");
    }

    function completeTask(index) {
      tasks[index].status = "Done";
      completed.push(tasks[index]);
      tasks.splice(index, 1);
      showList();
    }
  </script>
</body>
</html>