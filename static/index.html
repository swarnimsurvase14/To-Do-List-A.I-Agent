<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI To-Do List Agent </title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen text-slate-100">
  <div class="w-full max-w-md bg-slate-800 p-8 rounded-xl shadow-2xl shadow-slate-950/70">
    
    <div id="addTaskScreen" class="space-y-5">
      <h1 class="text-2xl font-extrabold text-center text-indigo-400 tracking-wide">AI Project Manager</h1>
      
      <textarea id="taskInput" rows="3" placeholder="e.g. Finish urgent homework tomorrow 5pm" 
        class="w-full p-4 rounded-lg bg-slate-700/70 text-slate-100 border border-slate-600 
               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
        oninput="handleInput(this.value)"></textarea>
      
      <div id="suggestionsBox" class="hidden bg-slate-700 p-2 rounded-lg text-sm space-y-2 border border-indigo-600/50"></div>

      <button onclick="addTask()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-full font-bold shadow-md 
               shadow-indigo-500/30 transition duration-150 disabled:bg-gray-500 disabled:cursor-not-allowed">
        Add Task
      </button>
      <button onclick="showList()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-full font-bold shadow-md transition duration-150">
        View Tasks
      </button>
    </div>
    
    <div id="taskListScreen" class="hidden space-y-5">
      <h1 class="text-2xl font-extrabold text-center text-indigo-400 tracking-wide">Your Tasks</h1>
      <ul id="taskList" class="space-y-4"></ul>

      <h2 class="text-lg font-extrabold pt-2 border-t border-slate-700">‚úÖ Completed</h2>
      <ul id="completedList" class="space-y-4"></ul>

      <button onclick="backToAdd()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-full font-bold mt-6 shadow-md transition duration-150">
        Add More
      </button>
    </div>
    
  </div>

  <script>
    let tasks = [];
    let completed = [];

    // --- INITIAL SETUP: Request Notification Permission ---
    function requestNotificationPermission() {
        if (!("Notification" in window)) return;
        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    }
    requestNotificationPermission(); 

    loadTasks(); 

    // ===========================================
    // EXTERNAL API ENDPOINTS
    // ** IMPORTANT: REPLACE 'http://localhost:3000' with your Render domain! **
    // Example: const API_BASE_URL = 'https://ai-todo-backend.onrender.com';
    // ===========================================
    const API_BASE_URL = 'https://gemini-todo-list-agent.onrender.com'; 
    const API_ANALYZE_ENDPOINT = API_BASE_URL + '/api/analyze'; 
    const API_SUGGEST_ENDPOINT = API_BASE_URL + '/api/suggest'; 


    // ===========================================
    // REAL-TIME PROACTIVE REMINDERS LOGIC
    // ===========================================
    
    function scheduleReminder(task) {
        let targetTimeStr = task.time.match(/(\d{4}-\d{2}-\d{2})/) ? task.time : task.time + ' 09:00';
        
        let targetDate = new Date(targetTimeStr);

        if (isNaN(targetDate.getTime()) || task.time.toLowerCase().includes('unspecified')) {
            console.log(`Reminder skipped for task: ${task.text} (Time ambiguous)`);
            return; 
        }

        let now = new Date();
        let delay = targetDate.getTime() - now.getTime();

        if (delay > 0 && delay < 2073600000) { 
            console.log(`Scheduling reminder for task: "${task.text}" in ${Math.round(delay / 60000)} minutes.`);
            
            setTimeout(() => {
                if (Notification.permission === "granted") {
                    new Notification("‚è≥ TASK DUE SOON!", {
                        body: task.text + " - Category: " + task.category,
                        icon: 'https://placehold.co/60x60/4f46e5/white?text=AI', 
                        tag: 'task-' + Date.now() 
                    });
                } else {
                    console.warn("Reminder time reached, but notification permission was denied.");
                }
            }, delay);
        } else if (delay <= 0) {
            console.log(`Task "${task.text}" is already overdue or due now.`);
        }
    }

    function loadTasks() {
         const storedTasks = localStorage.getItem('ai_tasks');
         const storedCompleted = localStorage.getItem('ai_completed');
    
        if (storedTasks) tasks = JSON.parse(storedTasks);
        if (storedCompleted) completed = JSON.parse(storedCompleted);
    }

    function saveTasks() {
        localStorage.setItem('ai_tasks', JSON.stringify(tasks));
        localStorage.setItem('ai_completed', JSON.stringify(completed));
    }

    // ===========================================
    // LOCAL FALLBACK LOGIC (Used if Flask server is down)
    // ===========================================
    function analyzeTaskFallback(text) {
        let task = { 
            text, 
            time: "unspecified", 
            category: "General", 
            urgent: false, 
            note: "‚ö†Ô∏è Using simplified local analysis. Time/Date may be inaccurate.", 
            effort_score: "Low",
            status: "Pending" 
        };

        if (text.match(/urgent|asap|important/i)) {
            task.urgent = true;
            task.note = "‚ö†Ô∏è Fallback: This looks urgent!";
            task.effort_score = "High";
        }
        if (text.match(/tomorrow/i)) task.time = "Tomorrow";
        else if (text.match(/today/i)) task.time = "Today";
        
        if (text.match(/homework|study|assignment/i)) task.category = "Study";
        else if (text.match(/meeting|work|project/i)) task.category = "Work";

        return task;
    }


    // ===========================================
    // AI SUGGESTION LOGIC 
    // ===========================================
    
    let suggestionTimeout;
    function handleInput(text) {
        clearTimeout(suggestionTimeout);
        let trimmedText = text.trim();
        
        if (trimmedText.length < 3) {
            document.getElementById("suggestionsBox").classList.add("hidden");
            return;
        }
        
        suggestionTimeout = setTimeout(() => {
            fetchAISuggestions(trimmedText);
        }, 500);
    }

    async function fetchAISuggestions(text) {
        let box = document.getElementById("suggestionsBox");
        box.innerHTML = '<div class="text-center text-indigo-400 animate-pulse">Loading AI suggestions...</div>';
        box.classList.remove("hidden");

        try {
            const response = await fetch(API_SUGGEST_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ partial_task: text })
            });

            if (!response.ok) { 
                throw new Error("Suggestion service offline."); 
            }

            const data = await response.json();
            const suggestions = data.suggestions || []; 

            box.innerHTML = ""; 
            
            if (suggestions.length > 0) {
                suggestions.forEach(s => {
                    let btn = document.createElement("button");
                    btn.className = "block w-full text-left bg-slate-700 hover:bg-indigo-600/50 p-2 rounded-md transition duration-150";
                    btn.textContent = s;
                    btn.onclick = () => {
                        document.getElementById("taskInput").value = s;
                        box.classList.add("hidden");
                    };
                    box.appendChild(btn);
                });
                box.classList.remove("hidden");
            } else {
                 box.innerHTML = '<div class="text-center text-slate-400">No AI suggestions found.</div>';
            }

        } catch (error) {
            box.classList.add("hidden");
            console.warn("Suggestion fetch failed. API likely unreachable.");
        }
    }


    // ===========================================
    // AI TASK ANALYSIS LOGIC (Primary with Fallback)
    // ===========================================

    async function addTask() {
      let input = document.getElementById("taskInput").value.trim();
      if (!input) return alert("Please enter a task!");

      const addButton = document.querySelector('button[onclick="addTask()"]');
      const originalButtonText = addButton.textContent;
      addButton.textContent = 'Analyzing Task...'; 
      addButton.disabled = true;

      let analyzed = null;

      try {
          // --- PRIMARY: Attempt to use the Python/Flask Backend ---
          const response = await fetch(API_ANALYZE_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ task_text: input })
          });

          if (!response.ok) {
              throw new Error("AI analysis service failed to respond correctly.");
          }

          const data = await response.json();
          analyzed = data; // Use the rich AI-generated data
          
          alert("AI analyzed and added task: " + analyzed.text);

      } catch (error) {
          // --- SECONDARY: FALLBACK TO LOCAL ANALYSIS ---
          console.error("Backend connection or API call failed. Falling back to local analysis.", error);
          analyzed = analyzeTaskFallback(input); // Use the simple local function
          alert("WARNING: AI Service Offline. Task added with simplified local analysis: " + analyzed.text);
      } 
      
      // --- FINAL PROCESSING (Regardless of success or failure) ---
      if (analyzed) {
          analyzed.status = analyzed.status || "Pending";
          tasks.push(analyzed);
          scheduleReminder(analyzed);
          saveTasks(); 
      }

      document.getElementById("taskInput").value = "";
      document.getElementById("suggestionsBox").classList.add("hidden");

      // 4. Restore button state
      addButton.textContent = originalButtonText;
      addButton.disabled = false;
      
    }
    
    // ===========================================
    // TASK MANAGEMENT LOGIC (Includes Overdue Check, Scoring, & Layout)
    // ===========================================

    function showList() {
        let list = document.getElementById("taskList");
        let completedList = document.getElementById("completedList");
        list.innerHTML = "";
        completedList.innerHTML = "";

        // Helper function to get today's date as a comparable string (YYYY-MM-DD)
        const getTodayString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const today = getTodayString();
        
        // Sorts tasks by urgency (urgent=true comes first)
        tasks.sort((a, b) => b.urgent - a.urgent);

        // --- Helper for Effort Score Colors ---
        const getEffortColor = (score) => {
            switch (score) {
                case 'Critical': return 'bg-red-700';
                case 'High': return 'bg-yellow-600';
                case 'Medium': return 'bg-indigo-600';
                case 'Low': return 'bg-emerald-600';
                default: return 'bg-slate-600';
            }
        };

        // Pending Tasks
        tasks.forEach((task, index) => {
            let li = document.createElement("li");
            
            // --- OVERDUE LOGIC & TAGGING ---
            let statusTag = 'üìå Pending'; 
            let timeClass = '';
            let isOverdue = false;

            // FIX: Use a flexible match to check for YYYY-MM-DD at the start of the time string
            if (task.time && task.time.match(/^\d{4}-\d{2}-\d{2}/)) {
                const taskDate = task.time.substring(0, 10);
                if (taskDate < today) {
                    statusTag = 'üî¥ OVERDUE';
                    timeClass = 'text-red-400 font-extrabold'; 
                    isOverdue = true;
                } else if (taskDate === today) {
                    statusTag = 'üóìÔ∏è TODAY';
                }
            }
            
            // Determine primary status tag
            if (task.urgent) {
                statusTag = 'üö® URGENT';
            } else if (isOverdue) {
                 statusTag = 'üî¥ OVERDUE';
            } else if (statusTag === 'üìå Pending' && task.time !== 'unspecified') {
                 statusTag = 'üïí SCHEDULED';
            }
            
            // Determine list item border color based on urgency or overdueness
            let urgencyBorder = task.urgent || isOverdue ? 'border-l-4 border-red-500' : 'border-l-4 border-slate-500';

            // Apply professional styling
            li.className = `p-4 rounded-md bg-slate-700/50 flex flex-col ${urgencyBorder}`;
            
            li.innerHTML = `
              <div class="flex justify-between items-center mb-1">
                <span class="${task.urgent || isOverdue ? 'text-red-400 font-extrabold tracking-tight' : 'font-semibold'}">
                  ${task.text}
                </span>
                <button onclick="completeTask(${index})" class="text-emerald-400 hover:text-emerald-500 font-bold ml-4 p-1 rounded transition duration-150">‚úî Done</button>
              </div>
              
              <p class="text-xs text-slate-400 pt-1 flex items-center justify-between">
                <span>
                    <span class="${timeClass}">üìÖ ${task.time}</span> 
                    | üè∑ ${task.category}
                </span>
                <span class="flex space-x-2">
                    <span class="font-bold px-2 py-0.5 rounded-full text-slate-100 ${getEffortColor(task.effort_score)} text-[10px]">
                        ${task.effort_score || 'Effort: N/A'}
                    </span>
                    <span class="font-bold px-2 py-0.5 rounded-full text-slate-100 bg-indigo-700/70 text-[10px]">
                        ${statusTag}
                    </span>
                </span>
              </p>
              
              <p class="text-xs text-slate-400 mt-2 italic">${task.note}</p>
            `;
            list.appendChild(li);
        });

        // Completed Tasks
        completed.forEach(task => {
            let li = document.createElement("li");
            li.className = "p-4 rounded-md bg-slate-700/30 flex flex-col opacity-70 border-l-4 border-emerald-500";
            
            li.innerHTML = `
              <div class="flex justify-between items-center">
                <span class="line-through text-slate-400">${task.text}</span>
                <span class="text-emerald-300 font-bold">‚úî Completed</span>
              </div>
              <p class="text-xs text-slate-400 mt-1">üìÖ ${task.time} | üè∑ ${task.category}</p>
            `;
            completedList.appendChild(li);
        });

        document.getElementById("addTaskScreen").classList.add("hidden");
        document.getElementById("taskListScreen").classList.remove("hidden");
    }

    function backToAdd() {
      document.getElementById("taskListScreen").classList.add("hidden");
      document.getElementById("addTaskScreen").classList.remove("hidden");
    }

    function completeTask(index) {
      tasks[index].status = "Done";
      completed.push(tasks[index]);
      tasks.splice(index, 1);
      saveTasks(); 
      showList();
    }
  </script>
</body>

</html>



